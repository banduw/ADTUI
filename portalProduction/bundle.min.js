!function o(s,a,n){function l(t,e){if(!a[t]){if(!s[t]){var i="function"==typeof require&&require;if(!e&&i)return i(t,!0);if(r)return r(t,!0);throw(i=new Error("Cannot find module '"+t+"'")).code="MODULE_NOT_FOUND",i}i=a[t]={exports:{}},s[t][0].call(i.exports,function(e){return l(s[t][1][e]||e)},i,i.exports,o,s,a,n)}return a[t].exports}for(var r="function"==typeof require&&require,e=0;e<n.length;e++)l(n[e]);return l}({1:[function(e,t,i){function o(){this.filters={},this.previousSelectedADT=null,this.selectedADT=null,this.allTwinsInfo=null,0==$("#adtInstanceSelectionDialog").length&&(this.DOM=$('<div id="adtInstanceSelectionDialog" title="Choose Data Set"></div>'),this.DOM.css("overflow","hidden"),$("body").append(this.DOM))}o.prototype.preparationFunc=async function(){return new Promise((i,t)=>{try{$.get("twinsFilter/readStartFilters",(e,t)=>{null!=e&&(this.filters=e),i()})}catch(e){t(e)}})},o.prototype.popup=function(){$.get("queryADT/listADTInstance",(e,t)=>{var i,o,s,a,n,l,r,d,c,p=e;0!=p.length&&(this.DOM.empty(),l=$('<label style="padding-right:5px;font-size:1.2em">ADT Instance</label>'),this.DOM.append(l),i=$("<select></select>"),this.DOM.append(i),p.forEach(e=>{var t=e.split(".")[0].replace("https://",""),t=$("<option value='"+e+"'>"+t+"</option>");i.append(t),null==this.filters[e]&&(this.filters[e]={})}),i.selectmenu({appendTo:this.DOM,change:(e,t)=>{this.selectedADT!=t.item.value&&this.setADTInstance(t.item.value)}}),c=$("<span style='display:block;position:relative;height:calc(100% - 45px);margin-top:5px'></span>"),this.DOM.append(c),(r=$("<span/>")).css({position:"absolute",left:"0px",height:"100%",top:"0px",border:"solid 1px grey",padding:"5px","overflow-x":"hidden","overflow-y":"auto",width:"195px"}),d=$("<ol  style='width:100%'/>"),r.append(d),d.selectable(),this.filterList=d,c.append(r),d.selectable({cancel:".ui-selected",selected:(e,t)=>{var i=$(t.selected).data("filterName"),t=$(t.selected).data("filterQuery");this.chooseOneFilter(i,t)}}),(o=$("<span/>")).css({position:"absolute",left:"210px",height:"100%",top:"0px",right:"0px",border:"solid 1px grey",padding:"5px"}),c.append(o),s=$("<span/>"),o.append(s),a=$("<span style='padding-right:1em'>Name</span>"),n=$("<input/>").addClass("ui-corner-all"),this.queryNameInput=n,e=$("<span style='display:block;padding-top:10px'>Query</span>"),l=$('<textarea style="width:calc(100% - 5px);overflow-y:auto;overflow-x:hidden;height:5em;font-size:10px"/>').addClass("ui-corner-all"),this.queryInput=l,r=$('<a class="ui-button ui-widget ui-corner-all" style="background-color:yellowgreen" href="#">Save</a>'),d=$('<a class="ui-button ui-widget ui-corner-all"  href="#">Test</a>'),c=$('<a class="ui-button ui-widget ui-corner-all" style="background-color:orangered" href="#">Delete Filter</a>'),d.click(()=>{this.testQuery()}),r.click(()=>{this.saveQuery()}),c.click(()=>{this.delQuery()}),s.append(a,n,e,l,r,d,c),d=$("<span style='display:block;border:solid 1px grey'></span>"),c=$("<table></table>"),this.testResultTable=c,d.css({"margin-top":"2px",overflow:"auto",position:"absolute",top:"135px",bottom:"1px",left:"1px",right:"1px"}),c.css({"border-collapse":"collapse"}),o.append(d),d.append(c),this.DOM.dialog({width:650,height:500,resizable:!1}),this.setADTInstance(p[0]))})},o.prototype.setADTInstance=function(e){null==this.previousSelectedADT||this.previousSelectedADT==e?this.DOM.dialog({buttons:[{text:"Replace",click:()=>{this.useFilterToReplace()}},{text:"Append",click:()=>{this.useFilterToAppend()}}]}):this.DOM.dialog({buttons:[{text:"Replace",click:()=>{this.useFilterToReplace()}}]}),this.selectedADT=e,this.listFilters(e),this.chooseOneFilter("",""),$.ajaxSetup({headers:{adtInstance:this.selectedADT}})},o.prototype.delQuery=function(){var e,t=this.queryNameInput.val();"ALL"!=t&&((e=$("<div/>")).text('Do you confirm to delete filter "'+t+'"?'),$("body").append(e),e.dialog({buttons:[{text:"Confirm",click:()=>{this.queryNameInput.val(""),this.queryInput.val(""),this.testResultTable.empty(),delete this.filters[this.selectedADT][t],this.listFilters(this.selectedADT),this.chooseOneFilter("",""),$.post("twinsFilter/saveStartFilters",{filters:this.filters}),e.dialog("destroy")}},{text:"Cancel",click:()=>{e.dialog("destroy")}}]}))},o.prototype.saveQuery=function(){var i=this.queryNameInput.val(),e=this.queryInput.val();""!=i?(this.filters[this.selectedADT][i]=e,this.listFilters(this.selectedADT),this.filterList.children().each((e,t)=>{$(t).data("filterName")==i&&$(t).addClass("ui-selected")}),$.post("twinsFilter/saveStartFilters",{filters:this.filters})):alert("Please fill in query name")},o.prototype.testQuery=function(){this.testResultTable.empty();var e=this.queryInput.val();""!=e&&$.post("queryADT/allTwinsInfo",{query:e},e=>{Array.isArray(e)?(this.allTwinsInfo=e).forEach(e=>{e=$('<tr><td style="border-right:solid 1px lightgrey;border-bottom:solid 1px lightgrey">'+e.$dtId+'</td><td style="border-bottom:solid 1px lightgrey">'+e.$metadata.$model+"</td></tr>");this.testResultTable.append(e)}):alert("Query is not correct!")})},o.prototype.listFilters=function(e){var t=this.filters[e];t.ALL="SELECT * FROM digitaltwins";var i,o=this.filterList;for(i in o.empty(),t){var s=$('<li style="font-size:1.2em" class="ui-widget-content">'+i+"</li>");s.css("cursor","default"),s.data("filterName",i),s.data("filterQuery",t[i]),"ALL"==i?o.prepend(s):o.append(s),s.dblclick(e=>{this.useFilterToReplace()})}},o.prototype.useFilterToAppend=function(){this.previousSelectedADT=this.selectedADT,""==this.queryInput.val()&&alert("Please fill in query to fetch data from digital twin service..")},o.prototype.useFilterToReplace=function(){this.previousSelectedADT=this.selectedADT,""!=this.queryInput.val()?(this.broadcastMessage({message:"ADTDatasourceChange",query:this.queryInput.val(),twins:this.allTwinsInfo}),this.DOM.dialog("close")):alert("Please fill in query to fetch data from digital twin service..")},o.prototype.chooseOneFilter=function(e,t){this.queryNameInput.val(e),this.queryInput.val(t),this.testResultTable.empty(),this.allTwinsInfo=null},t.exports=new o},{}],2:[function(e,t,i){const a=e("./modelAnalyzer");e("./modelAnalyzer");function o(){this.DOM=$("#infoPanel"),this.DOM.css({"margin-top":"10px","margin-left":"3px"}),this.selectedObjects=null}o.prototype.rxMessage=function(e){var t,i,o,s;this.DOM.empty(),"selectNodes"==e.message?(t=e.info,1==(this.selectedObjects=t).length?(s=t[0]).$dtId?(this.drawButtons("singleNode"),this.drawStaticInfo(this.DOM,{$dtId:s.$dtId},"1em","13px"),i=s.$metadata.$model,this.drawEditable(this.DOM,a.DTDLModels[i].editableProperties,s,[]),this.drawStaticInfo(this.DOM,{$etag:s.$etag,$metadata:s.$metadata},"1em","10px","DarkGray")):s.$sourceId&&(this.drawButtons("singleRelationship"),this.drawStaticInfo(this.DOM,{$sourceId:s.$sourceId,$targetId:s.$targetId,$relationshipName:s.$relationshipName,$relationshipId:s.$relationshipId},"1em","13px"),t=s.$relationshipName,i=s.sourceModel,this.drawEditable(this.DOM,this.getRelationShipEditableProperties(t,i),s,[]),this.drawStaticInfo(this.DOM,{$etag:s.$etag},"1em","10px","DarkGray")):(this.drawButtons("multiple"),this.drawMultipleObj())):"selectGroupNode"==e.message&&(s=e.info["@id"],o={$metadata:{$model:s}},e=$('<a class="ui-button ui-widget ui-corner-all" style="margin-bottom:10px" href="#">Add Twin</a>'),this.DOM.append(e),e.click(e=>{o.$dtId&&""!=o.$dtId?$.post("editADT/upsertDigitalTwin",{newTwinJson:JSON.stringify(o)},e=>{""!=e?alert(e):((e=this.DOM.find("#NEWTWIN_IDLabel").find("input"))&&e.val(""),$.post("queryADT/oneTwinInfo",{twinID:o.$dtId},e=>{this.broadcastMessage({message:"addNewTwin",twinInfo:e})}))}):alert("Please fill in name for the new digital twin")}),this.drawStaticInfo(this.DOM,{Model:s}),e.data("twinJson",o),(s=JSON.parse(JSON.stringify(a.DTDLModels[s].editableProperties))).$dtId="string",this.drawEditable(this.DOM,s,o,[],"newTwin"))},o.prototype.getRelationShipEditableProperties=function(e,t){if(a.DTDLModels[t].validRelationships[e])return a.DTDLModels[t].validRelationships[e].editableRelationshipProperties},o.prototype.drawButtons=function(e){var t,i,o;"singleRelationship"==e?(o=$('<a class="ui-button ui-widget ui-corner-all" style="background-color:orangered" href="#">Delete</a>'),this.DOM.append(o),o.click(()=>{this.deleteSelected()})):"singleNode"!=e&&"multiple"!=e||(t=$('<a class="ui-button ui-widget ui-corner-all" href="#">Show Inbound</a>'),i=$('<a class="ui-button ui-widget ui-corner-all"  href="#">Show Outbound</a>'),o=$('<a class="ui-button ui-widget ui-corner-all" style="background-color:orangered" href="#">Delete All</a>'),e=$('<a class="ui-button ui-widget ui-corner-all"  href="#">Connect To</a>'),this.DOM.append(t,i,o,e),i.click(()=>{this.addOutBound()}),t.click(()=>{this.addInBound()}),o.click(()=>{this.deleteSelected()}))},o.prototype.deleteSelected=async function(){var e=this.selectedObjects;if(0!=e.length){var t=[],i=[],o={};e.forEach(e=>{e.$sourceId?t.push(e):(i.push(e.$dtId),o[e.$dtId]=1)});for(var s=t.length-1;0<=s;s--){var a=t[s].$sourceId,n=t[s].$targetId;null==o[a]&&null==o[n]||t.splice(s,1)}var l=$("<div/>"),r="",d=i.length,e=t.length;0<d&&(r=d+" twin"+(1<d?"s":"")+" (with connected relations)"),0<d&&0<e&&(r+=" and additional "),0<e&&(r+=e+" relation"+(1<e?"s":"")),l.text(r+=" will be deleted. Please confirm"),$("body").append(l),l.dialog({buttons:[{text:"Confirm",click:()=>{0<i.length&&this.deleteTwins(i),0<t.length&&this.deleteRelations(t),l.dialog("destroy"),this.DOM.empty()}},{text:"Cancel",click:()=>{l.dialog("destroy")}}]})}},o.prototype.deleteTwins=async function(e){for(;0<e.length;){var t=e.splice(0,50),t=await this.deletePartialTwins(t);this.broadcastMessage({message:"twinsDeleted",twinIDArr:t})}},o.prototype.deletePartialTwins=async function(e){return new Promise((t,i)=>{try{$.post("editADT/deleteTwins",{arr:e},function(e){t(e)})}catch(e){i(e)}})},o.prototype.deleteRelations=async function(e){var t=[];e.forEach(e=>{t.push({srcID:e.$sourceId,relID:e.$relationshipId})})},o.prototype.addOutBound=async function(){var e=this.selectedObjects,t=[];for(e.forEach(e=>{e.$sourceId||t.push(e.$dtId)});0<t.length;){var i=t.splice(0,50),i=await this.fetchPartialOutbounds(i);this.broadcastMessage({message:"drawTwinsAndRelations",info:i})}},o.prototype.addInBound=async function(){var e=this.selectedObjects,t=[];for(e.forEach(e=>{e.$sourceId||t.push(e.$dtId)});0<t.length;){var i=t.splice(0,50),i=await this.fetchPartialInbounds(i);this.broadcastMessage({message:"drawTwinsAndRelations",info:i})}},o.prototype.fetchPartialOutbounds=async function(e){return new Promise((t,i)=>{try{$.post("queryADT/addOutBound",{arr:e},function(e){t(e)})}catch(e){i(e)}})},o.prototype.fetchPartialInbounds=async function(e){return new Promise((t,i)=>{try{$.post("queryADT/addInBound",{arr:e},function(e){t(e)})}catch(e){i(e)}})},o.prototype.drawMultipleObj=function(){var t=0,i=0,e=this.selectedObjects;null!=e&&(e.forEach(e=>{e.$sourceId?t++:i++}),(e=$("<label style='display:block;margin-top:10px'></label>")).text(i+" node"+(i<=1?"":"s")+", "+t+" relationship"+(t<=1?"":"s")),this.DOM.append(e))},o.prototype.drawStaticInfo=function(e,t,i,o,s){for(var a in t){var n=$("<label style='display:block'><div style='background-color:#f6f6f6;border:solid 1px grey;display:inline;padding:.1em .3em .1em .3em;margin-right:.3em'>"+a+"</div></label>");n.css({fontSize:o,color:s}),e.append(n),n.css("padding-top",i);var l=$("<label></label>");"object"==typeof t[a]?(l.css("display","block"),l.css("padding-left","1em"),this.drawStaticInfo(l,t[a],".5em",o)):(l.css("padding-top",".2em"),l.text(t[a])),l.css({fontSize:o,color:s}),n.append(l)}},o.prototype.drawEditable=function(e,t,i,o,s){if(null!=t)for(var a in t){var n=$("<label style='display:block'><div style='display:inline;padding:.1em .3em .1em .3em'>"+a+"</div></label>");s&&"$dtId"==a?(e.prepend(n),n.attr("id","NEWTWIN_IDLabel")):e.append(n),n.css("padding-top",".3em");var l,r,d,c=$("<label style='padding-top:.2em'></label>"),p=o.concat([a]);Array.isArray(t[a])?(l=$("<select></select>"),c.append(l),l.data("path",p),l.append($("<option></option>")),t[a].forEach(e=>{var t=e.displayName||e.enumValue,t=$("<option value='"+e.enumValue+"'>"+t+"</option>");l.append(t)}),l.selectmenu({change:(e,t)=>{this.editDTProperty(i,$(e.target).data("path"),t.item.value,"string",s)}}),null!=(d=this.searchValue(i,p))&&(l.val(d),l.selectmenu("refresh"))):"object"==typeof t[a]?(c.css("display","block"),c.css("padding-left","1em"),this.drawEditable(c,t[a],i,p,s)):((r=$('<input type="text"/>').addClass("ui-corner-all")).css("border","solid 1px grey"),c.append(r),null!=(d=this.searchValue(i,p))&&r.val(d),r.data("path",p),r.data("dataType",t[a]),r.change(e=>{this.editDTProperty(i,$(e.target).data("path"),$(e.target).val(),$(e.target).data("dataType"),s)})),n.append(c)}},o.prototype.editDTProperty=function(t,i,o,e,s){var a,n,l,r,d;["double","boolean","float","integer","long"].includes(e)&&(o=Number(o)),s?this.updateOriginObjectValue(t,i,o):(n=1==i.length?(a="",i.forEach(e=>{a+="/"+e}),[{op:"add",path:a,value:o}]):(n=i[0],r=null==(r=t[n])?{}:JSON.parse(JSON.stringify(r)),this.updateOriginObjectValue(r,i.slice(1),o),[{op:"add",path:"/"+n,value:r}]),t.$dtId?(l=t.$dtId,d={jsonPatch:JSON.stringify(n),twinID:l}):t.$relationshipId&&(l=t.$sourceId,r=t.$relationshipId,d={jsonPatch:JSON.stringify(n),twinID:l,relationshipID:r}),$.post("editADT/changeAttribute",d,e=>{""!=e?alert(e):this.updateOriginObjectValue(t,i,o)}))},o.prototype.updateOriginObjectValue=function(e,t,i){if(0!=t.length)for(var o=e,s=0;s<t.length;s++){var a=t[s];if(s==t.length-1){o[a]=i;break}null==o[a]&&(o[a]={}),o=o[a]}},o.prototype.searchValue=function(e,t){if(0==t.length)return null;for(var i=e,o=0;o<t.length;o++)if(null==(i=i[t[o]]))return null;return i},t.exports=o},{"./modelAnalyzer":6}],3:[function(e,t,i){const o=e("./mainUI.js");$("document").ready(function(){new o})},{"./mainUI.js":5}],4:[function(e,t,i){const o=e("./adtInstanceSelectionDialog"),s=e("./modelManagerDialog");t.exports=function(){this.switchADTInstanceBtn=$('<a class="ui-button ui-widget ui-corner-all" href="#">Source</a>'),this.modelIOBtn=$('<a class="ui-button ui-widget ui-corner-all" href="#">Models</a>'),this.showForgeViewBtn=$('<a class="ui-button ui-widget ui-corner-all" href="#">ForgeView</a>'),this.showGISViewBtn=$('<a class="ui-button ui-widget ui-corner-all" href="#">GISView</a>'),this.switchLayoutSelector=$("<select></select>"),$("#mainToolBar").empty(),$("#mainToolBar").append(this.switchADTInstanceBtn,this.modelIOBtn,this.showForgeViewBtn,this.showGISViewBtn,this.switchLayoutSelector),this.switchADTInstanceBtn.click(()=>{o.popup()}),this.modelIOBtn.click(()=>{s.popup()}),this.switchLayoutSelector.html("<option disabled selected>Choose Layout...</option><option selected>Default</option><option>Custom1</option><option>+ New layout</option>"),this.switchLayoutSelector.selectmenu({change:(e,t)=>{console.log(t.item.value)}})}},{"./adtInstanceSelectionDialog":1,"./modelManagerDialog":7}],5:[function(e,t,i){"use strict";const o=e("./topologyDOM.js"),s=e("./twinsTree"),a=e("./adtInstanceSelectionDialog"),n=e("./modelManagerDialog"),l=e("./mainToolbar"),r=e("./infoPanel");function d(){this.initUILayout(),this.twinsTree=new s($("#treeHolder"),$("#treeSearch")),this.mainToolbar=new l,this.topologyInstance=new o($("#canvas")),this.topologyInstance.init(),this.infoPanel=new r,this.broadcastMessage(),this.prepareData()}d.prototype.prepareData=async function(){var e=[n.preparationFunc(),a.preparationFunc()];await Promise.allSettled(e),a.popup()},d.prototype.assignBroadcastMessage=function(t){t.broadcastMessage=e=>{this.broadcastMessage(t,e)}},d.prototype.broadcastMessage=function(e,t){var i=[this.twinsTree,a,n,this.mainToolbar,this.topologyInstance,this.infoPanel];if(null==e)for(var o=0;o<i.length;o++)this.assignBroadcastMessage(s=i[o]);else for(var s,o=0;o<i.length;o++)(s=i[o]).rxMessage&&s!=e&&s.rxMessage(t)},d.prototype.initUILayout=function(){$("body").layout({closable:!0,resizable:!0,slidable:!0,livePaneResizing:!0,north__slidable:!1,north__spacing_closed:6,north__resizable:!1,north__closable:!1,west__minSize:100,east__size:300,east__minSize:200,east__maxSize:.5,center__minWidth:100});$.layout.disableTextSelection=function(){var e=$(document),t="textSelectionDisabled",i="textSelectionInitialized";$.fn.disableSelection&&(e.data(i)||e.on("mouseup",$.layout.enableTextSelection).data(i,!0),e.data(t)||e.disableSelection().data(t,!0))},$.layout.enableTextSelection=function(){var e=$(document),t="textSelectionDisabled";$.fn.enableSelection&&e.data(t)&&e.enableSelection().data(t,!1)},$(".ui-layout-resizer").disableSelection().on("mousedown",$.layout.disableTextSelection)},t.exports=d},{"./adtInstanceSelectionDialog":1,"./infoPanel":2,"./mainToolbar":4,"./modelManagerDialog":7,"./topologyDOM.js":9,"./twinsTree":10}],6:[function(e,t,i){function o(){this.DTDLModels={},this.relationshipTypes={}}o.prototype.clearAllModels=function(){for(var e in this.DTDLModels)delete this.DTDLModels[e]},o.prototype.addModels=function(e){e.forEach(e=>{var t=e["@id"];this.DTDLModels[t]=e})},o.prototype.expandEditablePropertiesFromBaseClass=function(t,e){var i=this.DTDLModels[e];if(null!=i){if(i.editableProperties)for(var o in i.editableProperties)t[o]=i.editableProperties[o];e=i.extends;null!=e&&(Array.isArray(e)?e:[e]).forEach(e=>{this.expandEditablePropertiesFromBaseClass(t,e)})}},o.prototype.expandValidRelationshipTypesFromBaseClass=function(t,e){var i=this.DTDLModels[e];if(null!=i){if(i.validRelationships)for(var o in i.validRelationships)null==t[o]&&(t[o]=this.relationshipTypes[o][e]);i=i.extends;null!=i&&(Array.isArray(i)?i:[i]).forEach(e=>{this.expandValidRelationshipTypesFromBaseClass(t,e)})}},o.prototype.expandEditableProperties=function(i,e,o){e.forEach(e=>{var t;"Relationship"!=e["@type"]&&("Property"==e["@type"]||Array.isArray(e["@type"])&&e["@type"].includes("Property")||null==e["@type"])&&("object"!=typeof e.schema&&null!=o[e.schema]&&(e.schema=o[e.schema]),"object"==typeof e.schema&&"Object"==e.schema["@type"]?(i[e.name]=t={},this.expandEditableProperties(t,e.schema.fields,o)):"object"==typeof e.schema&&"Enum"==e.schema["@type"]?i[e.name]=e.schema.enumValues:i[e.name]=e.schema)})},o.prototype.analyze=function(){for(var e in this.relationshipTypes)delete this.relationshipTypes[e];for(var t in this.DTDLModels){var i=this.DTDLModels[t],o={};i.schemas&&(Array.isArray(i.schemas)?i.schemas:[i.schemas]).forEach(e=>{o[e["@id"]]=e});var s=i.contents;s&&s.forEach(e=>{"Relationship"==e["@type"]&&(this.relationshipTypes[e.name]||(this.relationshipTypes[e.name]={}),(this.relationshipTypes[e.name][t]=e).editableRelationshipProperties={},Array.isArray(e.properties)&&this.expandEditableProperties(e.editableRelationshipProperties,e.properties,o))})}for(var t in this.DTDLModels){i=this.DTDLModels[t],o={};i.schemas&&(Array.isArray(i.schemas)?i.schemas:[i.schemas]).forEach(e=>{o[e["@id"]]=e}),i.editableProperties={},i.validRelationships={},Array.isArray(i.contents)&&(this.expandEditableProperties(i.editableProperties,i.contents,o),i.contents.forEach(e=>{"Relationship"==e["@type"]&&(i.validRelationships[e.name]=this.relationshipTypes[e.name][t])}))}for(var t in this.DTDLModels){var a=(i=this.DTDLModels[t]).extends;null!=a&&(Array.isArray(a)?a:[a]).forEach(e=>{this.expandEditablePropertiesFromBaseClass(i.editableProperties,e),this.expandValidRelationshipTypesFromBaseClass(i.validRelationships,e)})}},t.exports=new o},{}],7:[function(e,t,i){const a=e("./modelAnalyzer"),n=e("./adtInstanceSelectionDialog");function o(){this.visualDefinition={},this.models={},0==$("#modelManagerDialog").length&&(this.DOM=$('<div id="modelManagerDialog" title="Models"></div>'),this.DOM.css("overflow","hidden"),$("body").append(this.DOM))}o.prototype.preparationFunc=async function(){return new Promise((i,t)=>{try{$.get("visualDefinition/readVisualDefinition",(e,t)=>{""!=e&&"object"==typeof e&&(this.visualDefinition=e),i()})}catch(e){t(e)}})},o.prototype.popup=function(){this.DOM.empty();var e=$('<a class="ui-button ui-widget ui-corner-all" href="#">Import</a>'),t=$('<input type="file" name="modelFiles" multiple="multiple" style="display:none"></input>');this.DOM.append(e,t),e.click(()=>{t.trigger("click")}),t.change(e=>{e=e.target.files;this.readModelFilesContentAndImport(e)});var i=$("<span/>");this.DOM.append(i),i.css({position:"absolute",left:"0px",bottom:"0px",top:"40px",border:"solid 1px grey",padding:"5px","overflow-x":"hidden","overflow-y":"auto",width:"195px"});e=$("<ol  style='width:100%'/>");i.append(e),e.selectable(),(this.modelList=e).selectable({selected:(e,t)=>{t=$(t.selected).data("modelName");this.fillRightSpan(t)}});e=$("<span/>");e.css({position:"absolute",left:"210px",bottom:"0px",top:"5px",right:"0px",border:"solid 1px grey",padding:"5px","overflow-x":"hidden","overflow-y":"auto"}),this.DOM.append(e),(this.rightSpan=e).addClass("ui-accordion ui-widget ui-helper-reset"),this.DOM.dialog({width:650,height:500,resizable:!1,buttons:[]}),this.listModels()},o.prototype.fillRightSpan=async function(e){this.rightSpan.empty();var t=this.models[e]["@id"],i=$('<a class="ui-button ui-widget ui-corner-all" style="background-color:orangered" href="#">Delete</a>');this.rightSpan.append(i),i.click(()=>{$.post("editADT/deleteModel",{model:t},e=>{""==e?(this.listModels("shouldBroadcast"),this.rightSpan.empty(),this.visualDefinition[n.selectedADT]&&this.visualDefinition[n.selectedADT][t]&&(delete this.visualDefinition[n.selectedADT][t],this.saveVisualDefinition())):alert(e)})});var o=this.addAPartInRightSpan("Visualization"),s=this.addAPartInRightSpan("Editable Properties And Relationships"),i=this.addAPartInRightSpan("Original Definition"),e=JSON.stringify(this.models[e],null,2);i.append($('<pre id="json">'+e+"</pre>"));e=a.DTDLModels[t].editableProperties;this.fillEditableProperties(e,s);e=a.DTDLModels[t].validRelationships;this.fillRelationshipInfo(e,s),this.fillVisualization(t,o)},o.prototype.fillVisualization=function(e,t){var i,o=a.DTDLModels[e];for(i in this.addOneVisualizationRow(e,t),o.validRelationships)this.addOneVisualizationRow(e,t,i)},o.prototype.addOneVisualizationRow=function(i,e,o){var t=null==o?"◯":"⟜ "+o,s=$("<div style='padding-bottom:8px'></div>");e.append(s);e=$("<label style='margin-right:10px'>"+t+"</label>");s.append(e);t=null,e=this.visualDefinition[n.selectedADT];null==o?e&&e[i]&&e[i].color&&(t=e[i].color):e&&e[i]&&e[i].relationships&&e[i].relationships[o]&&(t=e[i].relationships[o]);var a=$("<select></select>");s.append(a);["Black","Red","Green","Blue","Bisque","Brown","Coral","Crimson","DodgerBlue","Gold"].forEach(e=>{var t=$("<option value='"+e+"'>"+e+"▧</option>");a.append(t),t.css("color",e)}),null!=t&&(a.val(t),a.css("color",t)),a.change(e=>{var t=e.target.value;a.css("color",t),this.visualDefinition[n.selectedADT]||(this.visualDefinition[n.selectedADT]={});e=this.visualDefinition[n.selectedADT];e[i]||(e[i]={}),o?(e[i].relationships||(e[i].relationships={}),e[i].relationships[o]=t,this.broadcastMessage({message:"visualDefinitionChange",srcModelID:i,relationshipName:o,colorCode:t})):(e[i].color=t,this.broadcastMessage({message:"visualDefinitionChange",modelID:i,colorCode:t})),this.saveVisualDefinition()})},o.prototype.saveVisualDefinition=function(){$.post("visualDefinition/saveVisualDefinition",{visualDefinitionJson:this.visualDefinition})},o.prototype.fillRelationshipInfo=function(e,t){for(var i in e){var o=$("<label style='display:inline;padding:.1em .3em .1em .3em;margin-right:.3em'>"+i+"</label>");t.append(o),o.css("padding-top",".1em");o=$("<label style='display:inline;background-color:yellowgreen;color:white;font-size:9px;padding:2px'>Relationship type</label>");t.append(o);o=$("<label></label>");o.css("display","block"),o.css("padding-left","1em"),t.append(o),this.fillEditableProperties(e[i].editableRelationshipProperties,o)}},o.prototype.fillEditableProperties=function(e,t){for(var i in e){var o=$("<label style='display:block'><div style='display:inline;padding:.1em .3em .1em .3em;margin-right:.3em'>"+i+"</div></label>");t.append(o),o.css("padding-top",".1em");var s=$("<label></label>");Array.isArray(e[i])?(s.text("enum"),s.css({"background-color":"darkGray",color:"white",fontSize:"9px",padding:"2px"})):"object"==typeof e[i]?(s.css("display","block"),s.css("padding-left","1em"),this.fillEditableProperties(e[i],s)):(s.text(e[i]),s.css({"background-color":"darkGray",color:"white",fontSize:"9px",padding:"2px"})),o.append(s)}},o.prototype.addAPartInRightSpan=function(e){var i=$('<h3 class="accordion-header ui-accordion-header ui-helper-reset ui-state-default ui-accordion-icons ui-corner-all"><span class="ui-accordion-header-icon ui-icon ui-icon-triangle-1-e"></span></h3>');i.text(e);var o=$('<div class="ui-accordion-content ui-helper-reset ui-widget-content ui-corner-bottom"></div>');return this.rightSpan.append(i,o),i.click(()=>{var e=o,t=e.is(":visible");return t?(i.children(":first").removeClass("ui-icon-triangle-1-s"),i.children(":first").addClass("ui-icon-triangle-1-e")):(i.children(":first").removeClass("ui-icon-triangle-1-e"),i.children(":first").addClass("ui-icon-triangle-1-s")),e[t?"slideUp":"slideDown"]().trigger(t?"hide":"show"),!1}),o},o.prototype.readModelFilesContentAndImport=async function(e){for(var t,i=[],o=0;t=e[o];o++)if("application/json"==t.type)try{var s=await this.readOneFile(t),a=JSON.parse(s);i.push(a)}catch(e){}0!=i.length&&$.post("editADT/importModels",{models:i},e=>{""==e?this.listModels("shouldBroadCast"):alert(e)})},o.prototype.readOneFile=async function(o){return new Promise((e,t)=>{try{var i=new FileReader;i.onload=()=>{e(i.result)},i.readAsText(o)}catch(e){t(e)}})},o.prototype.listModels=function(s){for(var e in this.modelList.empty(),this.models)delete this.models[e];$.get("queryADT/listModels",(e,t)=>{e.forEach(e=>{this.models[e.displayName]=e}),s&&(a.clearAllModels(),a.addModels(e),a.analyze());var i,o=[];for(i in this.models)o.push(i);o.sort(function(e,t){return e.toLowerCase().localeCompare(t.toLowerCase())}),o.forEach(e=>{var t=$('<li style="font-size:1.2em" class="ui-widget-content">'+e+"</li>");t.css("cursor","default"),t.data("modelName",e),this.modelList.append(t)}),s&&this.broadcastMessage({message:"ADTModelsChange",models:this.models})})},t.exports=new o},{"./adtInstanceSelectionDialog":1,"./modelAnalyzer":6}],8:[function(e,t,i){"use strict";function o(e){this.DOM=e,this.DOM.addClass("ui-accordion ui-widget ui-helper-reset"),this.groupNodes=[],this.selectedNodes=[]}function s(e,t){this.parentTree=e,this.info=t,this.childLeafNodes=[],this.name=t.displayName,this.createDOM()}function a(e,t){this.parentGroupNode=e,this.leafInfo=t,this.name=this.leafInfo.$dtId,this.createLeafNodeDOM()}o.prototype.scrollToLeafNode=function(e){var t=this.DOM.scrollTop(),i=this.DOM.height(),e=e.DOM.position().top;i-50<e?this.DOM.scrollTop(t+e-(i-50)):e<50&&this.DOM.scrollTop(t+(e-50))},o.prototype.firstLeafNode=function(){if(0==this.groupNodes.length)return null;var t=null;return this.groupNodes.forEach(e=>{null==t&&0<e.childLeafNodes.length&&(t=e.childLeafNodes[0])}),t},o.prototype.nextGroupNode=function(e){if(null!=e){e=this.groupNodes.indexOf(e);return this.groupNodes.length-1>e?this.groupNodes[e+1]:this.groupNodes[0]}},o.prototype.nextLeafNode=function(e){if(null!=e){var t=e.parentGroupNode,e=t.childLeafNodes.indexOf(e);if(t.childLeafNodes.length-1>e)return t.childLeafNodes[e+1];for(;;){var i=this.nextGroupNode(t);if(0!=i.childLeafNodes.length)return i.childLeafNodes[0];t=i}}},o.prototype.searchText=function(e){if(""==e)return null;var t,i=new RegExp(e,"i");if(0==this.selectedNodes.length){if(null==(t=this.firstLeafNode()))return;if(null!=t.name.match(i))return t}else t=this.selectedNodes[0];if(null==t)return null;for(var o=t;;){var s=this.nextLeafNode(o);if(s==t)return null;if(null!=s.name.match(i))return s;o=s}},o.prototype.addLeafnodeToGroup=function(e,t,i){e=this.findGroupNode(e);null!=e&&e.addNode(t,i)},o.prototype.removeAllNodes=function(){this.groupNodes.length=0,this.selectedNodes.length=0,this.DOM.empty()},o.prototype.findGroupNode=function(t){var i=null;return this.groupNodes.forEach(e=>{e.name==t&&(i=e)}),i},o.prototype.delGroupNode=function(e){e.deleteSelf()},o.prototype.deleteLeafNode=function(t){var i=null;this.groupNodes.forEach(e=>{null==i&&e.childLeafNodes.forEach(e=>{e.name==t&&(i=e)})}),null!=i&&i.deleteSelf()},o.prototype.insertGroupNode=function(e,t){var i=new s(this,e),e=this.findGroupNode(i.name);if(null==e)return this.groupNodes.splice(t,0,i),0==t?(this.DOM.append(i.headerDOM),this.DOM.append(i.listDOM)):(t=this.groupNodes[t-1],i.headerDOM.insertAfter(t.listDOM),i.listDOM.insertAfter(i.headerDOM)),i},o.prototype.addGroupNode=function(e){e=new s(this,e);if(null==this.findGroupNode(e.name))return this.groupNodes.push(e),this.DOM.append(e.headerDOM),this.DOM.append(e.listDOM),e},o.prototype.selectLeafNode=function(e){this.selectLeafNodeArr([e])},o.prototype.appendLeafNodeToSelection=function(e){var t=[].concat(this.selectedNodes);t.push(e),this.selectLeafNodeArr(t)},o.prototype.selectGroupNode=function(e){this.callback_afterSelectGroupNode&&this.callback_afterSelectGroupNode(e.info)},o.prototype.selectLeafNodeArr=function(e){for(var t=0;t<this.selectedNodes.length;t++)this.selectedNodes[t].dim();this.selectedNodes.length=0,this.selectedNodes=this.selectedNodes.concat(e);for(t=0;t<this.selectedNodes.length;t++)this.selectedNodes[t].highlight();this.callback_afterSelectNodes&&this.callback_afterSelectNodes(this.selectedNodes)},o.prototype.dblClickNode=function(e){this.callback_afterDblclickNode&&this.callback_afterDblclickNode(e)},s.prototype.isOpen=function(){var e=this.headerDOM.next();return!!e&&e.is(":visible")},s.prototype.refreshName=function(){this.headerDOM.text(this.name+"("+this.childLeafNodes.length+")"),0<this.childLeafNodes.length?this.headerDOM.css("font-weight","bold"):this.headerDOM.css("font-weight","normal")},s.prototype.deleteSelf=function(){this.headerDOM.remove(),this.listDOM.remove();var e=this.parentTree.groupNodes,t=e.indexOf(this);-1<t&&e.splice(t,1)},s.prototype.createDOM=function(){this.headerDOM=$('<h3 class="accordion-header ui-accordion-header ui-helper-reset ui-state-default ui-accordion-icons ui-corner-all"><span class="ui-accordion-header-icon ui-icon ui-icon-triangle-1-e"></span></h3>'),this.refreshName(),this.listDOM=$('<div class="ui-accordion-content ui-helper-reset ui-widget-content ui-corner-bottom"></div>'),this.headerDOM.click(e=>(this.isOpen()?this.shrink():this.expand(),this.parentTree.selectGroupNode(this),!1))},s.prototype.expand=function(){var e=this.listDOM;this.isOpen()||(this.headerDOM.children(":first").removeClass("ui-icon-triangle-1-e"),this.headerDOM.children(":first").addClass("ui-icon-triangle-1-s"),e.slideDown().trigger("show"))},s.prototype.shrink=function(){var e=this.listDOM;this.isOpen()&&(this.headerDOM.children(":first").removeClass("ui-icon-triangle-1-s"),this.headerDOM.children(":first").addClass("ui-icon-triangle-1-e"),e.slideUp().trigger("hide"))},s.prototype.addNode=function(t,e){if(e){var i=!1;if(this.childLeafNodes.forEach(e=>{e.name==t.$dtId&&(i=!0)}),i)return}e=new a(this,t);this.childLeafNodes.push(e),this.refreshName(),this.listDOM.append(e.DOM)},a.prototype.deleteSelf=function(){this.DOM.remove();var e=this.parentGroupNode,t=e.childLeafNodes.indexOf(this);-1<t&&e.childLeafNodes.splice(t,1),e.refreshName()},a.prototype.createLeafNodeDOM=function(){this.DOM=$('<li style="padding-left:3px;padding-top:1px;cursor:default">'+this.name+"</li>");var t=e=>{this.highlight(),e.ctrlKey?this.parentGroupNode.parentTree.appendLeafNodeToSelection(this):this.parentGroupNode.parentTree.selectLeafNode(this)};this.DOM.click(e=>{t(e)}),this.DOM.dblclick(e=>{t(e),this.parentGroupNode.parentTree.dblClickNode(this)})},a.prototype.highlight=function(){this.DOM.css("background-color","orange")},a.prototype.dim=function(){this.DOM.css("background-color","")},t.exports=o},{}],9:[function(e,t,i){"use strict";const o=e("./modelManagerDialog"),s=e("./adtInstanceSelectionDialog");function a(e){this.DOM=e,this.defaultNodeSize=30}a.prototype.init=function(){this.core=cytoscape({container:this.DOM[0],zoom:1,pan:{x:0,y:0},minZoom:1e-50,maxZoom:1e50,zoomingEnabled:!0,userZoomingEnabled:!0,panningEnabled:!0,userPanningEnabled:!0,boxSelectionEnabled:!0,selectionType:"single",touchTapThreshold:8,desktopTapThreshold:4,autolock:!1,autoungrabify:!1,autounselectify:!1,headless:!1,styleEnabled:!0,hideEdgesOnViewport:!1,textureOnViewport:!1,motionBlur:!1,motionBlurOpacity:.2,pixelRatio:"auto",elements:[],style:[{selector:"node",style:{width:this.defaultNodeSize,height:this.defaultNodeSize,label:"data(id)",opacity:.9}},{selector:".foo",style:{"background-color":"#606",label:"data(id)",shape:"ellipse","background-image":function(e){return"images/"+e.data("img")+".png"},"background-fit":"contain"}},{selector:"edge",style:{width:2,"line-color":"#888","target-arrow-color":"#000","target-arrow-shape":"triangle","curve-style":"bezier"}},{selector:"edge:selected",style:{width:3,"line-color":"red","target-arrow-color":"red","source-arrow-color":"red"}},{selector:"node:selected",style:{"border-color":"red","border-width":2,"background-color":"Gray"}}],layout:{name:"circle",radius:100}}),this.core.boxSelectionEnabled(!0);var t=e=>{var t,i=this.core.$(":selected");0!=i.length&&(t=[],i.forEach(e=>{t.push(e.data().originalInfo)}),this.broadcastMessage({message:"selectNodes",info:t}))};this.core.on("tapselect",t),this.core.on("tapunselect",t),this.core.on("boxend",e=>{this.core.one("boxselect",t)})},a.prototype.updateModelTwinColor=function(e,t){this.core.style().selector('node[modelID = "'+e+'"]').style({"background-color":t}).update()},a.prototype.updateRelationshipColor=function(e,t,i){this.core.style().selector('edge[sourceModel = "'+e+'"][relationshipName = "'+t+'"]').style({"line-color":i}).update()},a.prototype.deleteTwins=function(e){e.forEach(e=>{this.core.$('[id = "'+e+'"]').remove()})},a.prototype.animateANode=function(e){e.animate({style:{height:2*this.defaultNodeSize,width:2*this.defaultNodeSize},duration:200,complete:()=>{e.animate({style:{height:this.defaultNodeSize,width:this.defaultNodeSize},duration:200})}})},a.prototype.drawTwins=function(e,t){for(var i=[],o=0;o<e.length;o++){var s=e[o],a={data:{},group:"nodes"};a.data.originalInfo=s,a.data.id=s.$dtId;s=s.$metadata.$model;a.data.modelID=s,i.push(a)}var n=this.core.add(i);return this.noPosition_grid(n),t&&n.forEach(e=>{this.animateANode(e)}),n},a.prototype.drawRelations=function(e){for(var t=[],i=0;i<e.length;i++){var o,s=e[i],a={data:{},group:"edges"};a.data.originalInfo=s,a.data.id=s.$relationshipName+"_"+s.$relationshipId,a.data.source=s.$sourceId,a.data.target=s.$targetId,0!=this.core.$("#"+a.data.source).length&&0!=this.core.$("#"+a.data.target).length&&(o=this.core.$("#"+a.data.source)[0].data("originalInfo").$metadata.$model,s.sourceModel=o,a.data.sourceModel=o,a.data.relationshipName=s.$relationshipName,t.push(a))}return this.core.add(t)},a.prototype.drawTwinsAndRelations=function(e){e.forEach(e=>{var t,i=[];for(t in e.childTwins)i.push(e.childTwins[t]);var o=this.drawTwins(i,"animation"),s=e.relationships,a=this.drawRelations(s),s=a.sources(),a=o.union(a.union(s));this.noPosition_concentric(a,s.boundingBox())})},a.prototype.applyVisualDefinition=function(){var e=o.visualDefinition[s.selectedADT];if(null!=e)for(var t in e)if(e[t].color&&this.updateModelTwinColor(t,e[t].color),e[t].relationships)for(var i in e[t].relationships)this.updateRelationshipColor(t,i,e[t].relationships[i])},a.prototype.rxMessage=function(e){var t;"ADTDatasourceChange"==e.message?(this.core.nodes().remove(),this.applyVisualDefinition()):"refreshAllTwin"==e.message?(this.core.nodes().remove(),this.drawTwins(e.info)):"drawAllRelations"==e.message?(this.drawRelations(e.info),0!=this.core.edges().size()&&this.noPosition_cose()):"addNewTwin"==e.message?this.drawTwins([e.twinInfo],"animation"):"drawTwinsAndRelations"==e.message?this.drawTwinsAndRelations(e.info):"selectNodes"==e.message?(this.core.nodes().unselect(),this.core.edges().unselect(),e.info.forEach(e=>{e=this.core.nodes("#"+e.$dtId);e.select(),this.animateANode(e)})):"PanToNode"==e.message?(t=e.info,(t=this.core.nodes("#"+t.$dtId))&&this.core.center(t)):"visualDefinitionChange"==e.message?e.srcModelID?this.updateRelationshipColor(e.srcModelID,e.relationshipName,e.colorCode):this.updateModelTwinColor(e.modelID,e.colorCode):"twinsDeleted"==e.message&&this.deleteTwins(e.twinIDArr)},a.prototype.noPosition_grid=function(e){e.layout({name:"grid",animate:!1,fit:!1}).run()},a.prototype.noPosition_cose=function(e){(e=null==e?this.core.elements():e).layout({name:"cose",animate:!0,gravity:1,animationDuration:500}).run()},a.prototype.noPosition_concentric=function(e,t){(e=null==e?this.core.elements():e).layout({name:"concentric",animate:!1,fit:!1,minNodeSpacing:60,gravity:1,boundingBox:t}).run()},a.prototype.layoutWithNodePosition=function(e){this.core.layout({name:"preset",positions:e,animate:!1,animationDuration:500}).run()},t.exports=a},{"./adtInstanceSelectionDialog":1,"./modelManagerDialog":7}],10:[function(e,t,i){const o=e("./simpleTree"),r=e("./modelAnalyzer");function s(e,t){this.tree=new o(e),this.modelIDMapToName={},this.tree.callback_afterSelectNodes=e=>{var i=[];e.forEach((e,t)=>{i.push(e.leafInfo)}),this.broadcastMessage({message:"selectNodes",info:i})},this.tree.callback_afterDblclickNode=e=>{this.broadcastMessage({message:"PanToNode",info:e.leafInfo})},this.tree.callback_afterSelectGroupNode=e=>{this.broadcastMessage({message:"selectGroupNode",info:e})},this.searchBox=$('<input type="text"/>').addClass("ui-corner-all"),this.searchBox.css({border:"solid 1px grey",height:"calc(100% - 4px)",width:"calc(100% - 7px)"}),t.append(this.searchBox),this.searchBox.keyup(e=>{13!=e.keyCode||null!=(e=this.tree.searchText($(e.target).val()))&&(e.parentGroupNode.expand(),this.tree.selectLeafNode(e),this.tree.scrollToLeafNode(e))})}s.prototype.rxMessage=function(e){"ADTDatasourceChange"==e.message?this.refreshContent(e.query,e.twins):"drawTwinsAndRelations"==e.message?this.drawTwinsAndRelations(e.info):"ADTModelsChange"==e.message?this.refreshModels(e.models):"addNewTwin"==e.message?this.drawOneTwin(e.twinInfo):"twinsDeleted"==e.message&&this.deleteTwins(e.twinIDArr)},s.prototype.deleteTwins=function(e){e.forEach(e=>{this.tree.deleteLeafNode(e)})},s.prototype.refreshModels=function(t){this.tree.groupNodes.forEach(e=>{null==t[e.name]&&e.deleteSelf()});var i=[];this.tree.groupNodes.forEach(e=>{i.push(e.name)});var e,o=[];for(e in t)o.push(e);o.sort(function(e,t){return e.toLowerCase().localeCompare(t.toLowerCase())});for(var s=0;s<o.length;s++)s<i.length&&i[s]==o[s]||(this.tree.insertGroupNode(t[o[s]],s).shrink(),i.splice(s,0,o[s]))},s.prototype.refreshContent=function(a,n){var e,l=this.tree;for(e in l.removeAllNodes(),this.modelIDMapToName)delete this.modelIDMapToName[e];$.get("queryADT/listModels",(e,t)=>{for(var i=[],o={},s=0;s<e.length;s++)this.modelIDMapToName[e[s]["@id"]]=e[s].displayName,i.push(e[s].displayName),o[e[s].displayName]=e[s];i.sort(function(e,t){return e.toLowerCase().localeCompare(t.toLowerCase())}),i.forEach(e=>{l.addGroupNode(o[e]).shrink()}),r.clearAllModels(),r.addModels(e),r.analyze(),null!=n?this.renderAllTwins(n):$.post("queryADT/allTwinsInfo",{query:a},e=>{this.renderAllTwins(e)})})},s.prototype.drawTwinsAndRelations=function(e){e.forEach(e=>{for(var t in e.childTwins){t=e.childTwins[t];this.drawOneTwin(t)}})},s.prototype.drawOneTwin=function(e){var t=this.modelIDMapToName[e.$metadata.$model];this.tree.addLeafnodeToGroup(t,e,"skipRepeat")},s.prototype.renderAllTwins=function(e){var t=[];this.broadcastMessage({message:"refreshAllTwin",info:e});for(var i=0;i<e.length;i++){var o=this.modelIDMapToName[e[i].$metadata.$model];this.tree.addLeafnodeToGroup(o,e[i]),t.push(e[i].$dtId)}this.fetchAllRelationships(t)},s.prototype.fetchAllRelationships=async function(e){for(;0<e.length;){var t=e.splice(0,50),t=await this.fetchPartialRelationships(t);this.broadcastMessage({message:"drawAllRelations",info:t})}},s.prototype.fetchPartialRelationships=async function(e){return new Promise((t,i)=>{try{$.post("queryADT/allRelationships",{arr:e},function(e){t(e)})}catch(e){i(e)}})},t.exports=s},{"./modelAnalyzer":6,"./simpleTree":8}]},{},[3]);